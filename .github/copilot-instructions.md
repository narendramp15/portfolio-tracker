# Portfolio Tracker AI Coding Instructions

## Project Overview

**Portfolio Tracker** is a full-stack investment portfolio management application with:
- **Backend**: FastAPI + SQLAlchemy (Python 3.13+) with multi-broker integration (Zerodha, Angel, 5Paisa)
- **Frontend**: Modern React SPA with TypeScript, React Router, Zustand, TanStack Query, Tailwind CSS
- **Database**: SQLAlchemy ORM with Pydantic validation
- **Development Tool**: `uv` for Python package management (cross-platform, faster than pip)

## Architecture Patterns

### Backend Architecture
1. **Routers Pattern**: API endpoints organized in `portfolio_tracker/routers/` (auth, broker, portfolio, transactions, dashboard)
   - Each domain has dedicated router files; routers registered twice for backward compatibility (see `main.py` lines 66-75)
2. **Models → Schemas Pipeline**: SQLAlchemy ORM models in `models.py` → Pydantic schemas in `schemas.py` for request/response validation
3. **Dependency Injection**: FastAPI's `Depends()` for auth (`get_current_user` from `deps.py`), database sessions (`get_db`), CRUD operations
4. **Encryption for Secrets**: `EncryptionManager` encrypts/decrypts broker credentials before DB storage
5. **CORS**: Wildcard allow-origins for dev; must restrict for production

### Frontend Architecture
1. **React Router v7**: App-based routing in `src/router/router.tsx` with `RequireAuth` protection wrapper
2. **Zustand State**: Minimal global state (`selectedPortfolioId`) in `src/store/appStore.ts` with localStorage persistence
3. **TanStack Query**: Primary data fetching with caching; uses `api` client for all requests
4. **Axios Interceptor**: Bearer token auto-injected from `localStorage.access_token` in `src/lib/api.ts`
5. **Tailwind + Lucide**: CSS utility-first with lucide-react icons

### Broker Integration Pattern
- **Pluggable Brokers**: `portfolio_tracker/brokers/` contains broker classes (ZerodhaBroker, AngelBroker, FivepaisaBroker)
- **OAuth2 Flow**: Zerodha redirects to `ZERODHA_REDIRECT_URL` env var after user login
- **Unified Interface**: `__init__()`, `get_login_url()`, `set_access_token(request_token)`, `set_token(token)`, `get_holdings()` 
- **Credential Storage**: Encrypted per-user in `broker_config` table via `EncryptionManager`
- **Query Params**: Broker setup endpoints use Query params (not request body) - e.g., `api_key=...&api_secret=...`

## Development Workflows

### Setup & Running
```bash
# Backend (Python 3.13+ required)
uv sync --all-extras
uv run uvicorn portfolio_tracker.main:app --reload

# Frontend (separate terminal)
cd frontend && npm install && npm run dev  # Proxies /api to localhost:8000
```

### Testing & Quality
```bash
uv run pytest --cov=portfolio_tracker  # Run with coverage
uv run black . && uv run ruff check . && uv run mypy portfolio_tracker  # All checks
```

### Production Build
```bash
cd frontend && npm run build  # Creates dist/; FastAPI serves from there
```

## Key Code Patterns

### Database & CRUD
- **Session Management**: `db: Session = Depends(get_db)` in router functions
- **Relationships**: SQLAlchemy `back_populates` for bidirectional refs; `cascade="all, delete-orphan"` for cleanup
- **Decimal Precision**: Use `Decimal(20,8)` for financial values (never float) - converted via `_to_decimal()` helper
- **Timestamps**: All models have `created_at` (immutable), `updated_at` (auto-updates) with timezone-aware datetime

### Authentication  
- **JWT Tokens**: Generated by `create_access_token()` in `auth.py`; decoded by `get_current_user` in `deps.py`
- **Protected Routes**: Depend on `get_current_user` which fetches user from DB after JWT decode
- **Password Hashing**: Argon2 via passlib; never store plaintext
- **Storage**: JWT in localStorage key `access_token`, auto-injected by axios

### API Design
- **Base URL**: All routes under `/api/{resource}` (mounted in `main.py`)
- **Query Parameters**: Broker setup prefers Query params - e.g., `POST /api/broker/zerodha/setup?api_key=...&api_secret=...`
- **Validation**: Pydantic schemas; use `response_model` in route decorators
- **Errors**: Raise `HTTPException` with status codes; details shown to frontend
- **Backward Compat**: Routers registered at multiple prefixes for old API consumers

### Frontend Components
- **Card Component**: Base wrapper in `src/ui/components/Card.tsx` - template for other cards
- **BrokerSetupForm**: Accepts `brokerType` (union type), `brokerName`, `onSuccess` callback
- **API Calls**: Use `api` axios instance from `src/lib/api.ts` (auto-adds Bearer header)
- **Gradients**: Tailwind classes by broker: zerodha=`purple-600/700`, angel=`pink-600/700`, fivepaisa=`cyan-600/700`

## Critical Files & Concepts

| File | Purpose |
|------|---------|
| `main.py` | FastAPI init, CORS, router mounting, SPA static serving |
| `models.py` | SQLAlchemy ORM: User, Portfolio, Asset, Transaction, BrokerTemplate, BrokerConfig |
| `schemas.py` | Pydantic: UserRegister, AssetBase, BrokerHolding, BrokerConfig schemas |
| `routers/*.py` | Domain-specific endpoints (auth, broker, portfolio, transactions, dashboard) |
| `brokers/*.py` | Broker integrations (Zerodha KiteConnect, Angel, 5Paisa) |
| `encryption.py` | EncryptionManager for credential encryption/decryption |
| `database.py` | SQLAlchemy Base, connection, `create_tables()` on startup |
| `crud.py` | Helper functions for CRUD operations |
| `deps.py` | FastAPI dependencies: `get_current_user`, `get_db` |
| `frontend/src/App.tsx` | React Router + AppProviders |
| `frontend/src/lib/api.ts` | Axios instance + JWT interceptor |
| `frontend/src/store/appStore.ts` | Zustand store for portfolio selection |

## Common Tasks

### Adding a New Broker
1. Create `portfolio_tracker/brokers/new_broker.py` implementing interface methods
2. Add `@router.post("/new_broker/setup")` endpoint in `broker.py` using Query params
3. Handle OAuth callback: decrypt creds, exchange token, store encrypted access token via `crud.update_broker_config()`
4. Update `BrokerSetupForm.tsx`: add to `BrokerType` union, `brokerColors`, `brokerIcons` records
5. Test: creds → login URL → callback → holdings

### Adding an API Endpoint
1. Define Pydantic schemas in `schemas.py`
2. Add route in `routers/{domain}.py` with `Depends(get_current_user)`, `Depends(get_db)`
3. Use CRUD helpers from `crud.py` for database operations
4. Return validated Pydantic response

### Modifying Frontend State
1. **Global state**: Update Zustand store in `appStore.ts`, use `useAppStore()` hook
2. **API data**: Use TanStack Query with `api` client
3. **Sensitive data**: Store only in localStorage (via interceptor), never in Zustand

## Database & Environment

- **SQLite**: Default database (configured in `database.py`)
- **Env vars**: `ZERODHA_API_KEY`, `ZERODHA_API_SECRET`, `ZERODHA_REDIRECT_URL` (and Angel/5Paisa equivalents)
- **Migrations**: No Alembic; models auto-create tables on startup via `create_tables()`
- **Transaction Model**: Linked to Assets with price, quantity, type (buy/sell)

## Important Conventions

- **Type Hints**: Full annotations required (mypy enabled)
- **Naming**: snake_case (Python), camelCase (TypeScript/React)
- **Components**: One per file in `frontend/src/ui/components/`
- **Errors**: User-facing in HTTPException detail; server-side logging
- **Finance**: Always Decimal (never float) - use `_to_decimal()` helper
- **Tokens**: localStorage key `access_token`, injected by axios
- **CORS**: Dev allows all; restrict in production via `main.py`
- **Unused Files**: `schema.py` (singular) unused - use `schemas.py`

## Debugging Tips

- **Backend logs**: `uv run uvicorn portfolio_tracker.main:app --reload --log-level debug`
- **Network requests**: Browser DevTools → Network tab to inspect `/api/*` + JWT headers
- **Database**: SQLite browser to view `portfolio.db`
- **Encryption**: Verify `EncryptionManager.encrypt/decrypt` symmetry in broker callbacks
- **CORS errors**: Check `CORSMiddleware` in `main.py`
