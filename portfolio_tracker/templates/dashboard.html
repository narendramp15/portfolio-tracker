{% extends "base.html" %}

{% block title %}Dashboard - Portfolio Tracker{% endblock %}
{% block page_title %}Dashboard{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Period Selector -->
    <div class="period-selector mb-4">
        <button class="period-btn active" data-period="1d">1D</button>
        <button class="period-btn" data-period="1w">1W</button>
        <button class="period-btn" data-period="1m">1M</button>
        <button class="period-btn" data-period="3m">3M</button>
        <button class="period-btn" data-period="1y">1Y</button>
        <button class="period-btn" data-period="all">ALL</button>
    </div>

    <!-- Stats Grid -->
    <div id="stats-container" class="grid grid-3 mb-4">
        <div class="flex-center" style="grid-column: 1 / -1; padding: 2rem;">
            <div style="text-align: center;">
                <div class="spinner"
                    style="font-size: 2rem; margin: 0 auto; width: 2rem; height: 2rem; border: 3px solid #f3f3f3; border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite;">
                </div>
                <p class="mt-2">Loading dashboard data...</p>
            </div>
        </div>
    </div>

    <!-- Main Charts Grid -->
    <div class="grid grid-auto mb-4">
        <!-- Portfolio Composition -->
        <div class="card">
            <div class="widget-header">
                <span class="widget-title">
                    <i class="fas fa-chart-pie"></i> Portfolio Composition
                </span>
            </div>
            <div class="chart-container">
                <canvas id="compositionChart"></canvas>
            </div>
        </div>

        <!-- Performance Breakdown -->
        <div class="card">
            <div class="widget-header">
                <span class="widget-title">
                    <i class="fas fa-chart-bar"></i> Performance
                </span>
            </div>
            <div class="chart-container">
                <canvas id="performanceChart"></canvas>
            </div>
        </div>

        <!-- Asset Allocation -->
        <div class="card">
            <div class="widget-header">
                <span class="widget-title">
                    <i class="fas fa-chart-doughnut"></i> Asset Allocation
                </span>
            </div>
            <div class="chart-container">
                <canvas id="allocationChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Bottom Widgets Grid -->
    <div class="grid grid-2 mb-4">
        <!-- Top Assets -->
        <div class="card">
            <div class="widget-header">
                <span class="widget-title">
                    <i class="fas fa-star"></i> Top Assets
                </span>
            </div>
            <div id="top-assets-container" class="top-assets">
                <div class="empty-state">
                    <i class="fas fa-inbox empty-state-icon"></i>
                    <p class="empty-state-text">No assets yet</p>
                </div>
            </div>
        </div>

        <!-- Market Overview -->
        <div class="card">
            <div class="widget-header">
                <span class="widget-title">
                    <i class="fas fa-fire"></i> Top Gainers & Losers
                </span>
            </div>
            <div id="gainers-losers-container">
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="font-size: 0.9rem; color: #666; margin-bottom: 1rem; text-transform: uppercase;">
                        <i class="fas fa-arrow-up" style="color: var(--secondary); margin-right: 0.5rem;"></i>Top Gainers
                    </h4>
                    <div id="gainers-list" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
                </div>
                <div>
                    <h4 style="font-size: 0.9rem; color: #666; margin-bottom: 1rem; text-transform: uppercase;">
                        <i class="fas fa-arrow-down" style="color: var(--danger); margin-right: 0.5rem;"></i>Top Losers
                    </h4>
                    <div id="losers-list" style="display: flex; flex-direction: column; gap: 0.75rem;"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let compositionChart, performanceChart, allocationChart;

    async function loadDashboard() {
        try {
            const response = await fetch('/api/dashboard/stats');
            const stats = await response.json();

            renderStats(stats);
            initializeCharts(stats);
            renderTopAssets(stats);
            renderGainersLosers(stats);
        } catch (error) {
            console.error('Error loading dashboard:', error);
            document.getElementById('stats-container').innerHTML = `
                <div class="alert alert-danger" style="grid-column: 1 / -1;">
                    <i class="fas fa-exclamation-circle"></i> Error loading dashboard data
                </div>
            `;
        }
    }

    function renderStats(stats) {
        const container = document.getElementById('stats-container');
        const gainLossClass = stats.total_gain_loss >= 0 ? 'positive' : 'negative';
        const gainLossIcon = stats.total_gain_loss >= 0 ? 'fa-arrow-up' : 'fa-arrow-down';

        container.innerHTML = `
            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%);">
                    <i class="fas fa-wallet"></i>
                </div>
                <div class="stat-content">
                    <h3>Total Value</h3>
                    <div class="value">$${parseFloat(stats.total_portfolio_value).toFixed(2)}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, var(--info) 0%, var(--primary) 100%);">
                    <i class="fas fa-handshake"></i>
                </div>
                <div class="stat-content">
                    <h3>Invested</h3>
                    <div class="value">$${parseFloat(stats.total_invested).toFixed(2)}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, ${stats.total_gain_loss >= 0 ? 'var(--secondary) 0%, var(--secondary-light)' : 'var(--danger) 0%, #f87171'} 100%);">
                    <i class="fas ${gainLossIcon}"></i>
                </div>
                <div class="stat-content">
                    <h3>Gain/Loss</h3>
                    <div class="value" style="color: ${stats.total_gain_loss >= 0 ? 'var(--secondary)' : 'var(--danger)'};">
                        $${parseFloat(stats.total_gain_loss).toFixed(2)}
                    </div>
                    <div class="change ${gainLossClass}">
                        ${parseFloat(stats.gain_loss_percentage).toFixed(2)}%
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);">
                    <i class="fas fa-briefcase"></i>
                </div>
                <div class="stat-content">
                    <h3>Portfolios</h3>
                    <div class="value">${stats.number_of_portfolios}</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon" style="background: linear-gradient(135deg, var(--accent) 0%, #22d3ee 100%);">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stat-content">
                    <h3>Assets</h3>
                    <div class="value">${stats.number_of_assets}</div>
                </div>
            </div>
        `;
    }

    function renderTopAssets(stats) {
        const container = document.getElementById('top-assets-container');

        if (!stats.top_assets || stats.top_assets.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <i class="fas fa-inbox empty-state-icon"></i>
                    <p class="empty-state-text">No assets yet</p>
                </div>
            `;
            return;
        }

        container.innerHTML = stats.top_assets.map(asset => `
            <div class="asset-row">
                <div class="asset-info">
                    <div class="asset-name">${asset.name}</div>
                    <div class="asset-price">${asset.quantity} units</div>
                </div>
                <div class="asset-stats">
                    <div class="asset-value">$${parseFloat(asset.current_value).toFixed(2)}</div>
                    <div class="asset-return ${asset.return_percent >= 0 ? 'positive' : 'negative'}">
                        ${asset.return_percent >= 0 ? '+' : ''}${parseFloat(asset.return_percent).toFixed(2)}%
                    </div>
                </div>
            </div>
        `).join('');
    }

    function renderGainersLosers(stats) {
        const gainersContainer = document.getElementById('gainers-list');
        const losersContainer = document.getElementById('losers-list');

        if (!stats.gainers || stats.gainers.length === 0) {
            gainersContainer.innerHTML = '<p style="color: #999; font-size: 0.9rem;">No gainers</p>';
        } else {
            gainersContainer.innerHTML = stats.gainers.map(asset => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(16, 185, 129, 0.05); border-radius: 6px; border-left: 3px solid var(--secondary);">
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">${asset.name}</div>
                        <div style="font-size: 0.85rem; color: #666;">$${parseFloat(asset.current_value).toFixed(2)}</div>
                    </div>
                    <div style="text-align: right; font-weight: 600; color: var(--secondary);">
                        +${parseFloat(asset.return_percent).toFixed(2)}%
                    </div>
                </div>
            `).join('');
        }

        if (!stats.losers || stats.losers.length === 0) {
            losersContainer.innerHTML = '<p style="color: #999; font-size: 0.9rem;">No losers</p>';
        } else {
            losersContainer.innerHTML = stats.losers.map(asset => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: rgba(239, 68, 68, 0.05); border-radius: 6px; border-left: 3px solid var(--danger);">
                    <div>
                        <div style="font-weight: 600; color: var(--dark);">${asset.name}</div>
                        <div style="font-size: 0.85rem; color: #666;">$${parseFloat(asset.current_value).toFixed(2)}</div>
                    </div>
                    <div style="text-align: right; font-weight: 600; color: var(--danger);">
                        ${parseFloat(asset.return_percent).toFixed(2)}%
                    </div>
                </div>
            `).join('');
        }
    }

    function initializeCharts(stats) {
        if (compositionChart) compositionChart.destroy();
        if (performanceChart) performanceChart.destroy();
        if (allocationChart) allocationChart.destroy();

        // Composition Chart
        const compositionCtx = document.getElementById('compositionChart');
        if (compositionCtx) {
            compositionChart = new Chart(compositionCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Invested', 'Gain/Loss'],
                    datasets: [{
                        data: [
                            parseFloat(stats.total_invested),
                            Math.max(0, parseFloat(stats.total_gain_loss))
                        ],
                        backgroundColor: [
                            'var(--primary)',
                            stats.total_gain_loss >= 0 ? 'var(--secondary)' : 'var(--danger)'
                        ],
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 15, font: { size: 12 } }
                        }
                    }
                }
            });
        }

        // Performance Chart
        const performanceCtx = document.getElementById('performanceChart');
        if (performanceCtx) {
            performanceChart = new Chart(performanceCtx, {
                type: 'bar',
                data: {
                    labels: ['Total Value', 'Invested', 'Gain/Loss'],
                    datasets: [{
                        label: 'Amount ($)',
                        data: [
                            parseFloat(stats.total_portfolio_value),
                            parseFloat(stats.total_invested),
                            parseFloat(stats.total_gain_loss)
                        ],
                        backgroundColor: [
                            'var(--primary)',
                            'var(--info)',
                            stats.total_gain_loss >= 0 ? 'var(--secondary)' : 'var(--danger)'
                        ],
                        borderRadius: 8,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false } },
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: { color: 'rgba(0, 0, 0, 0.05)' }
                        }
                    }
                }
            });
        }

        // Asset Allocation Chart
        const allocationCtx = document.getElementById('allocationChart');
        if (allocationCtx && stats.asset_allocation && stats.asset_allocation.length > 0) {
            const colors = [
                'var(--primary)',
                'var(--secondary)',
                'var(--accent)',
                'var(--warning)',
                'var(--info)',
                '#ec4899',
                '#a855f7',
                '#f97316'
            ];

            allocationChart = new Chart(allocationCtx, {
                type: 'pie',
                data: {
                    labels: stats.asset_allocation.map(a => a.name),
                    datasets: [{
                        data: stats.asset_allocation.map(a => a.percentage),
                        backgroundColor: colors.slice(0, stats.asset_allocation.length),
                        borderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { padding: 10, font: { size: 11 } }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });
        }
    }

    document.addEventListener('DOMContentLoaded', loadDashboard);

    // Period selector buttons
    document.querySelectorAll('.period-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            document.querySelectorAll('.period-btn').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
        });
    });

    setInterval(loadDashboard, 30000);
</script>
{% endblock %}